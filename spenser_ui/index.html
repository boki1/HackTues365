<!DOCTYPE html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Spenser Web UI</title>
<link rel="icon" href="https://visibleranking.com/images/favicon_library/favicon_454.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
  <div id="nav-div">
    <nav class="navbar navbar-dark bg-dark">
      <span>
          <button onclick="showAdder()" id="add-btn"><i class="fa fa-plus"></i></button>
          <button onclick="showRemover()" id="rem-btn"><i class="fa fa-minus"></i></button>
      </span>
      <center>
        <h1 id="header"><b>SPENSER UI</b></h1>
      </center>
      <form id="search-form" class="form-inline my-2 my-lg-0">
        <input onkeyup="filterTable()" id="search-inp" style="font-size: 20px;" class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
        <button id="search-btn" type="submit"><i class="fa fa-search"></i></button>
      </form>
    </nav>
  </div>
  <div id="db-table-div">
    <table id="db-table" cellspacing=2 cellpadding=5 class="table table-hover">
      <thead>
        <tr>
          <th scope="col">ID</th>
          <th scope="col">Name</th>
          <th scope="col">Pills</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><button class="id-button" onclick="showCard(this.textContent)">#TEST</button></td>
          <td contenteditable="true">Goshko</td>
          <td contenteditable="true">Analgin, Parcetamol</td>
        </tr>
        <tr>
          <td><button class="id-button" onclick="showCard(this.textContent)">#DEMO</button></td>
          <td contenteditable="true">Pesho</td>
          <td contenteditable="true">Nurofen, Propolki</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="card">
      <button id="close-card-btn" onclick="closeCard()"><i class="fa fa-close"></i></button>
      <center>
          <img id="male" src="./images/male.png" alt="Avatar">
          <img id="female" src="./images/female.png" alt="Avatar">            
          <img id="default" src="./images/default.png" alt="Avatar">            
          <b><h1 id="person"></h1></b>
      </center>

      <ul id="info">
          <h6 class="subheader">Sex: </h6><p id="sex-label"></p><br>            
          <h6 class="subheader">ID: </h6><p id="id-label"></p><br>
          <h6 class="subheader">Pills: </h6><p id="pills-label"></p><br>
          <h6 class="subheader">Contact name: </h6><p id="contact-name-label"></p><br>
          <h6 class="subheader">Contact phone: </h6><p id="contact-phone-label"></p><br>
          <h6 class="subheader">Birthday: </h6><p id="birthday-label"></p><br>
          <h6 class="subheader">Room: </h6><p id="room-label"></p><br>
          <h6 class="subheader">Entering date: </h6><p id="entering-date-label"></p>
      </ul>

  </div>  
</body>

<style>
  
  #card {
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
    transition: 0.3s;
    width: 20%;
    display: none;
    margin: auto auto;
  }

  #card:hover {
    box-shadow: 0 16px 50px 0 rgba(0, 0, 0, 0.2);
  }

  #female, #male, #default {
    margin-top: 15px;
    border: none;
    width: 50%;
    height: 50%;
    display: none;
  }

  #info {
    margin-top: 20px;
    margin-bottom: 20px;
    padding: 20px;
  }

  .subheader {
    margin: 0px;
    font-size: 22px;
    text-decoration: none;
    padding: 0px;
    display: inline;
  }

  #close-card-btn {
    color: rgb(51, 51, 51);
    background: rgb(51, 51, 51, 0);
    border: none;
    font-size: 22px;
    transition: .24s linear;
  }

  #close-card-btn:hover {
    font-size: 32px;
  }  

  #id-label, #sex-label, #contact-name-label, #contact-phone-label, 
  #birthday-label, #room-label, #entering-date-label, #pills-label {
    display: inline;
    text-align: right;
    font-size: 18px;
  }  

  #person {
    text-decoration: underline;
  }

  .id-button {
    border: none;
    background-color: rgb(51, 51, 51, 0);
  }
  
  .id-button:hover {
    cursor: pointer;
  }

  #header {
    font-size: 32px;
    color: white;
    text-decoration: bold;
    margin-left: 200px;
  }

  #db-table-div {
    width: 800px;
    margin: 0px auto;
    font-size: 24px;
  }
  
  table tr:hover > td {
    background-color: lightgreen;
  }

  #search {
    display: inline-block;
    text-align: center;
    margin: 0 auto;
    width: 475px;
    margin: 44px 44px 44px 300px;
    background-color: rgb(51, 51, 51);
    color: black;
  }

  #search-btn {
    background-color: rgb(51, 51, 51, 0);
    color: white;
    border: none;
    transition: .5s linear;
  }

  #search-btn:hover {
    color: lightgreen;
  }

  #nav-div {
    padding: 15px;
    font-size: 24px;
    position: relative;
  }

  body, html {
    margin: 0;
    height: 100%;
    background-image: url("images/elderly_wallpaper.jpg");
  }

  #add-btn, #rem-btn {
    background-color: rgb(51, 51, 51, 0);
    color: white;
    border: none;
    transition: .5s linear;
    width: 50px;
    margin: 10px;
    padding: 10px;
  }

  #add-btn:hover, #rem-btn:hover {
    color: lightgreen;
  }

  tr {
    background-color: rgba(0, 0, 0, 0.2);
  }

</style>

<script>
  function prepareForCard() {
    let table = document.getElementById("db-table");
    let addBtn = document.getElementById("add-btn");
    let removeBtn = document.getElementById("rem-btn");
    let searchInput = document.getElementById('search-inp');
    let searchBtn = document.getElementById('search-btn');
    let _header = document.getElementById('header');

    _header.style.marginLeft = '0';
    _header.style.marginRight = '100px';
    searchInput.style.display = 'none';
    searchBtn.style.color = 'rgb(51, 51, 51, 0)';
    removeBtn.style.color = 'rgb(51, 51, 51, 0)';    
    addBtn.style.color = 'rgb(51, 51, 51, 0)';
    table.style.display = 'none';
  }

  function prepareForTable() {
    let addBtn = document.getElementById("add-btn");
    let removeBtn = document.getElementById("rem-btn");
    let table = document.getElementById("db-table");   
    let searchInput = document.getElementById('search-inp');
    let searchBtn = document.getElementById('search-btn')
    let _header = document.getElementById('header');

    _header.style.marginLeft = '200px';
    _header.style.marginRight = '0';
    searchInput.style.display = 'inline';
    searchBtn.style.color = 'white';
    removeBtn.style.color = 'white';    
    addBtn.style.color = 'white';
    table.style.display = 'table';
  }

  function closeCard() {
    document.getElementById('card').style.display = 'none';
    prepareForTable();
  }

  function showCard(id) {
    console.log(id);
    prepareForCard();
    let rows = document.getElementById("db-table").getElementsByTagName("tr");
    let person, pills; 

    for (let i = 0; i < rows.length; ++i) {
      let candidate = rows[i].getElementsByTagName("td");
      if (candidate.length <= 0)
        continue;
      if (candidate[0].innerText == id) {
        person = candidate[1].innerText;
        pills = candidate[2].innerText;
        break;
      }
    }
    
    let _card = document.getElementById('card');
    _card.style.display = 'block';

    let _id = document.getElementById('id-label');
    let _contactName = document.getElementById('contact-name-label');
    let _contactPhone = document.getElementById('contact-phone-label');
    let _birthday = document.getElementById('birthday-label');
    let _room = document.getElementById('room-label');
    let _enteringDate = document.getElementById('entering-date-label');
    let _sex = document.getElementById('sex-label');
    let _person = document.getElementById('person');
    let _pills = document.getElementById('pills-label');

    _pills.innerHTML = pills;
    _person.innerHTML = person;
    _sex.innerHTML = '...';
    _id.innerHTML = id;
    _contactName.innerHTML = '...';
    _contactPhone.innerHTML = '...';
    _birthday.innerHTML = '...';
    _room.innerHTML = '...';
    _enteringDate.innerHTML = '...';

    let male = document.getElementById('male');
    let female = document.getElementById('female');
    let _default = document.getElementById('default');

    if (_sex.innerHTML == 'Male') {
        male.style.display = 'block';
    } else if (_sex.innerHTML == 'Female') {
        female.style.display = 'block';
    } else {
      _default.style.display = 'block';
    }
  }

  function filterTable () {
    let valID, valPerson, valPills_;
    let input = document.getElementById("search-inp");
    let filter = input.value.toUpperCase();
    let table = document.getElementById("db-table");
    let tr = table.getElementsByTagName("tr");

    for (i = 0; i < tr.length; ++i) {
      let id = tr[i].getElementsByTagName("td")[0];
      let person = tr[i].getElementsByTagName("td")[1];      
      let pills_ = tr[i].getElementsByTagName("td")[2];      
      
      if (id && person && pills_) {
        valID = id.textContent || id.innerText;
        valPerson = person.textContent || person.innerText;
        valPills_ = pills_.textContent || pills_.innerText;        
        if (valID.toUpperCase().indexOf(filter) > -1 ||
            valPerson.toUpperCase().indexOf(filter) > -1 ||
            valPills_.toUpperCase().indexOf(filter) > -1) {
          tr[i].style.display = "";
        } else {
          tr[i].style.display = "none";
        }
      }
    }
  }

  function showRemover() {
    let id = prompt('Patient ID:', 0);
    id = '#' + id;
    let table = document.getElementById("db-table");
    let rowIdx = 1;
    let appears = false;
    let input = document.getElementById("search-inp");
    let filter = input.value.toUpperCase();
    let tr = table.getElementsByTagName("tr");
    for (i = 0; i < tr.length; ++i) {
      td = tr[i].getElementsByTagName("td")[0];
      if (td) {
        value = td.textContent || td.innerText;
        if (value != id) {
          rowIdx++; 
        } else {
          appears = true;
          break;  
        }
      }
    }   
    if (appears) {
      table.deleteRow(rowIdx);
    } else {
      alert('User with this ID does not exist in records.')
    }
  }


  function calcNextIdx () {
    return document.getElementById("db-table").getElementsByTagName("tr").length;
  }

  function getFormattedOutput(fPills) {
    let fOutput = "";
    Object.keys(fPills).forEach(function(key) {
      fOutput += key;
      fOutput += ', ';
    });
    fOutput = fOutput.replace(/([, ]*)$/g, '')
    return fOutput;
  }

  function getFormattedOutputAsObj(pills) {
    let splitPills = pills.split('; ');
    let fPills = {};
    for (let i = 0; i < splitPills.length; ++i) {
      let doubleSplit = splitPills[i].split(' -> ');
      let med = doubleSplit[0];
      let hourDelay = doubleSplit[1];
      fPills[med] = parseInt(hourDelay);
    }
    return fPills;
  }

  function fillNewCells(row, idx, person, receipt) {
    let cell0 = row.insertCell(0);
    var cell1 = row.insertCell(1);
    var cell2 = row.insertCell(2);
    cell0.innerHTML = idx;
    cell1.innerHTML = person;
    cell2.innerHTML = receipt;
    cell1.contentEditable = "true";
    cell2.contentEditable = "true";
  }

  function showAdder () {
    let person = prompt("Name: ", "Name");
    if (!person) return;
    let pills = prompt("Format: pill -> delay hour;", "Pills")
    if (!pills) return;
    let pillObj = getFormattedOutputAsObj(pills);
    let fOutput = getFormattedOutput(pillObj);
    let rowIdx = calcNextIdx();
    let idx = generateRandomId();
    let row = document.getElementById("db-table").insertRow(rowIdx);
    fillNewCells(row, idx, person, fOutput);
  }

  function generateRandomId() {
    let appears = false;
    let ranID;
    do {
      ranID = '#' + Math.random().toString(36).substring(2, 6).toUpperCase();
      let value;
      let input = document.getElementById("search-inp");
      let filter = input.value.toUpperCase();
      let table = document.getElementById("db-table");
      let tr = table.getElementsByTagName("tr");

      for (i = 0; i < tr.length; ++i) {
        td = tr[i].getElementsByTagName("td")[0];
        if (td) {
          value = td.textContent || td.innerText;
          if (value == ranID) {
            break;
            appears = true;
          }
        }
      }   
    } while (appears); 
    
    return ranID;
  }
  
  // const connection = new WebSocket('ws://' + location.hostname + ':81/');
  
  // connection.addEventListener('message', () => {
  //   console.log('Message: ', event.data);
  //   for (let i = 0; i < 1; ++i) {
  //     let row = document.getElementById("db-table").insertRow(calcNextIdx());
  //     fillNewCells(row, generateRandomId(), event.data, 'TEST FILL' );
  //   }
  // });

</script>
</html>

